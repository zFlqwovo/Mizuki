---
import { siteConfig } from "../../config";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import { getSortedPosts } from "../../utils/content-utils";
import WidgetLayout from "./WidgetLayout.astro";

interface Props {
	class?: string;
	style?: string;
}

const { class: className, style } = Astro.props;

// 获取所有文章
const posts = await getSortedPosts();

// 创建文章日期映射（格式：YYYY-MM-DD -> 文章列表）
const postDateMap = new Map<string, { id: string; title: string; published: Date }[]>();
posts.forEach((post) => {
	const date = new Date(post.data.published);
	const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
	const existingPosts = postDateMap.get(dateKey) || [];
	postDateMap.set(dateKey, [...existingPosts, {
		id: post.id,
		title: post.data.title,
		published: post.data.published
	}]);
});

// 序列化所有文章数据供客户端使用
const allPostsData = posts.map((post) => ({
	id: post.id,
	title: post.data.title,
	published: post.data.published.toISOString(),
}));

// 月份名称（使用 i18n）
const monthNames = [
	i18n(I18nKey.calendarJanuary),
	i18n(I18nKey.calendarFebruary),
	i18n(I18nKey.calendarMarch),
	i18n(I18nKey.calendarApril),
	i18n(I18nKey.calendarMay),
	i18n(I18nKey.calendarJune),
	i18n(I18nKey.calendarJuly),
	i18n(I18nKey.calendarAugust),
	i18n(I18nKey.calendarSeptember),
	i18n(I18nKey.calendarOctober),
	i18n(I18nKey.calendarNovember),
	i18n(I18nKey.calendarDecember),
];

// 星期名称（简写，使用 i18n）
const weekDays = [
	i18n(I18nKey.calendarMonday),
	i18n(I18nKey.calendarTuesday),
	i18n(I18nKey.calendarWednesday),
	i18n(I18nKey.calendarThursday),
	i18n(I18nKey.calendarFriday),
	i18n(I18nKey.calendarSaturday),
	i18n(I18nKey.calendarSunday),
];

// 判断是否为中文环境
const isChinese = siteConfig.lang.startsWith("zh");
const yearSuffix = isChinese ? "年" : " ";
---

<WidgetLayout id="calendar-widget" class={`hidden md:block ${className}`} style={style}>
  <span slot="title-icon" id="calendar-widget-title" class="flex-1 text-left"></span>
  
  <div class="calendar-controls flex justify-between items-center mb-2">
    <button id="prev-month" class="px-2 py-1 rounded bg-[var(--btn-regular-bg)] hover:bg-[var(--btn-regular-bg-hover)]">←</button>
    <span id="calendar-month-year" class="font-medium"></span>
    <button id="next-month" class="px-2 py-1 rounded bg-[var(--btn-regular-bg)] hover:bg-[var(--btn-regular-bg-hover)]">→</button>
  </div>

  <div class="calendar-container">
    <!-- 星期标题 -->
    <div class="weekdays grid grid-cols-7 gap-1 mb-2">
      {weekDays.map(day => (
        <div class="text-center text-xs text-neutral-500 dark:text-neutral-400 font-medium">
          {day}
        </div>
      ))}
    </div>
    
    <!-- 日历格子（由客户端动态生成） -->
    <div class="calendar-grid grid grid-cols-7 gap-1" id="calendar-grid">
    </div>
    
    <!-- 文章列表 -->
    <div id="calendar-posts" class="mt-3">
      <div class="border-t border-neutral-200 dark:border-neutral-700 mb-2" id="calendar-posts-divider" style="display: none;"></div>
      <div class="flex flex-col gap-1" id="calendar-posts-list">
      </div>
    </div>
  </div>
</WidgetLayout>

<script is:inline define:vars={{ postDateMap: Object.fromEntries(postDateMap), allPostsData, monthNames, weekDays, yearSuffix }}>
  let currentYear = new Date().getFullYear();
  let currentMonth = new Date().getMonth();

  function renderCalendar() {
    const now = new Date();
    const currentDate = (currentYear === now.getFullYear() && currentMonth === now.getMonth()) ? now.getDate() : null;
    
    // 更新 Widget 标题
    const titleElement = document.getElementById('calendar-widget-title');
    const monthYearElement = document.getElementById('calendar-month-year');

    if (titleElement) {
    titleElement.textContent = `${currentYear}${yearSuffix}${monthNames[currentMonth]}`;
    titleElement.classList.remove('text-neutral-500', 'dark:text-neutral-400');
    titleElement.classList.add('text-black/90', 'dark:text-white/90', 'font-bold');
    }

   if (monthYearElement) {
   monthYearElement.textContent = `${currentYear}${yearSuffix}${monthNames[currentMonth]}`;
   monthYearElement.classList.remove('text-neutral-500', 'dark:text-neutral-400');
   monthYearElement.classList.add('text-black/90', 'dark:text-white/90', 'font-bold');
   }


    const firstDayOfMonth = (new Date(currentYear, currentMonth, 1).getDay() + 6) % 7;
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

    const calendarGrid = document.getElementById('calendar-grid');
    if (!calendarGrid) return;
    
    const calendarDays = [];
    for (let i = 0; i < firstDayOfMonth; i++) {
      calendarDays.push({ day: null, hasPost: false, count: 0, dateKey: "" });
    }
    for (let day = 1; day <= daysInMonth; day++) {
      const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const posts = postDateMap[dateKey] || [];
      calendarDays.push({
        day,
        hasPost: posts.length > 0,
        count: posts.length,
        dateKey
      });
    }

    calendarGrid.innerHTML = calendarDays.map(({day, hasPost, count, dateKey}) => {
      const isToday = day === currentDate;
      const classes = ["calendar-day aspect-square flex items-center justify-center rounded text-sm relative cursor-pointer"];
      if (!day) classes.push("text-neutral-400 dark:text-neutral-600");
      else if (!hasPost) classes.push("text-neutral-700 dark:text-neutral-300");
      else classes.push("text-neutral-900 dark:text-neutral-100 font-bold");
      if (isToday) classes.push("ring-2 ring-[var(--primary)]");
      return `
        <div
          class="${classes.join(' ')}"
          data-date="${dateKey}"
          data-has-post="${hasPost}"
        >
          ${day || ''}
          ${hasPost ? '<span class="absolute bottom-0 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-[var(--primary)]"></span>' : ''}
          ${hasPost && count > 1 ? `<span class="absolute top-0 right-0 text-[10px] text-[var(--primary)] font-bold">${count}</span>` : ''}
        </div>
      `;
    }).join('');

    const currentMonthPosts = allPostsData.filter(post => {
      const date = new Date(post.published);
      return date.getFullYear() === currentYear && date.getMonth() === currentMonth;
    });

    showMonthlyPosts(currentMonthPosts);
    setupClickHandlers(currentMonthPosts);
  }

  function showMonthlyPosts(currentMonthPosts) {
    const postsList = document.getElementById('calendar-posts-list');
    const divider = document.getElementById('calendar-posts-divider');
    if (postsList) {
      postsList.innerHTML = currentMonthPosts.map(post => `
        <a href="/posts/${post.id}/" class="block text-sm text-black/90 dark:text-white/90 hover:text-[var(--primary)] dark:hover:text-[var(--primary)] transition-colors truncate px-2 py-1 rounded hover:bg-[var(--btn-plain-bg-hover)]">
          ${post.title}
        </a>
      `).join('');
      if (divider) divider.style.display = currentMonthPosts.length > 0 ? 'block' : 'none';
    }
  }

  function setupClickHandlers(currentMonthPosts) {
    const calendarDays = document.querySelectorAll('.calendar-day[data-date]');
    const postsList = document.getElementById('calendar-posts-list');
    const divider = document.getElementById('calendar-posts-divider');
    let currentSelectedDay = null;

    calendarDays.forEach(dayElement => {
      dayElement.addEventListener('click', () => {
        const dateKey = dayElement.getAttribute('data-date');
        const hasPost = dayElement.getAttribute('data-has-post') === 'true';
        if (!hasPost || !dateKey) return;

        if (currentSelectedDay === dayElement) {
          dayElement.classList.remove('bg-[var(--primary)]', 'bg-opacity-10');
          currentSelectedDay = null;
          showMonthlyPosts(currentMonthPosts);
          return;
        }

        if (currentSelectedDay) currentSelectedDay.classList.remove('bg-[var(--primary)]', 'bg-opacity-10');

        dayElement.classList.add('bg-[var(--primary)]', 'bg-opacity-10');
        currentSelectedDay = dayElement;

        const posts = postDateMap[dateKey] || [];
        if (posts.length > 0 && postsList) {
          postsList.innerHTML = posts.map(post => `
            <a href="/posts/${post.id}/" class="block text-sm text-black/90 dark:text-white/90 hover:text-[var(--primary)] dark:hover:text-[var(--primary)] transition-colors truncate px-2 py-1 rounded hover:bg-[var(--btn-plain-bg-hover)]">
              ${post.title}
            </a>
          `).join('');
          if (divider) divider.style.display = 'block';
        }
      });
    });
  }

  document.getElementById('prev-month')?.addEventListener('click', () => {
    currentMonth--;
    if (currentMonth < 0) { currentMonth = 11; currentYear--; }
    renderCalendar();
  });

  document.getElementById('next-month')?.addEventListener('click', () => {
    currentMonth++;
    if (currentMonth > 11) { currentMonth = 0; currentYear++; }
    renderCalendar();
  });

  renderCalendar();
</script>

<style>
  .calendar-day { transition: all 0.2s ease; min-height: 32px; }
  .calendar-day[data-has-post="true"]:hover { transform: translateY(-2px); }
</style>

